name: Aggregator Daily Build

on:
  schedule:
    # 每天 UTC 时间 0:00 运行 (北京时间 8:00)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # 允许手动触发

permissions:
  contents: write

jobs:
  # --- 第一阶段：下载与聚合 ---
  fetch_raw:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@main

    - name: Set up Python
      uses: actions/setup-python@main
      with:
        python-version: 'x'
        check-latest: true
        # 移除了 cache: 'pip' 以修复 "No file matched" 错误

    - name: Install Dependencies
      run: |
        pip install requests PyYAML

    - name: Run Aggregator Script
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python aggregator.py

    # 1. 提交原始节点 (聚合完成后提交到 nodes.txt)
    - name: Commit Raw Nodes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add nodes.txt
        # 如果没有新节点变化，忽略错误不退出
        git commit -m "Update raw nodes [$(date)]" || exit 0
        git push

    # 2. 上传工件 (确保下一个 Job 能精准拿到这份数据)
    - name: Upload Raw Artifact
      uses: actions/upload-artifact@v4
      with:
        name: raw-nodes
        path: nodes.txt
        retention-days: 1

  # --- 第二阶段：测试与清洗 ---
  check_active:
    needs: fetch_raw # 必须等待下载任务完成
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@main

    - name: Set up Python
      uses: actions/setup-python@main
      with:
        python-version: 'x'
        check-latest: true

    # 3. 下载上一步生成的原始节点
    - name: Download Raw Artifact
      uses: actions/download-artifact@v4
      with:
        name: raw-nodes
        # 默认下载到当前目录，会覆盖 checkout 下来的 nodes.txt

    - name: Run Check Active Script
      run: |
        # 读取 nodes.txt (脏数据)，生成 nodes.txt (清洗后) 和 sub.txt
        python check_active.py

    - name: Commit Final Results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 1. 先把修改添加到暂存区
        git add sub.txt nodes.txt
        
        # 2. 提交到本地仓库
        # 如果文件没有变化，commit 会返回非 0 状态码，所以使用 || exit 0 忽略
        git commit -m "Auto-update proxy nodes [$(date)]" || exit 0
        
        # 3. 此时工作区是干净的，可以安全地拉取远程修改并重排提交
        # 这会把 fetch_raw job 的提交放在最下面，把当前的测试结果放在最上面
        git pull --rebase
        
        # 4. 最后推送
        git push
